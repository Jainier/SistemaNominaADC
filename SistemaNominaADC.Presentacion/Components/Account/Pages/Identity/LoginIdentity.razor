@page "/Account/Login"

@using System.ComponentModel.DataAnnotations
@using SistemaNominaADC.Entidades.DTOs
@using SistemaNominaADC.Presentacion.Services.Auth

@inject HttpClient Http
@inject NavigationManager Navigation
@inject SessionService oSessionService

<PageTitle>Log in</PageTitle>

<h1>Log in</h1>

<div class="row">
    <div class="col-md-4">
        <EditForm Model="oInput" OnValidSubmit="LoginUser">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="form-floating mb-3">
                <InputText @bind-Value="oInput.Email"
                           class="form-control"
                           placeholder="email" />
                <label>Email</label>
            </div>

            <div class="form-floating mb-3">
                <InputText type="password"
                           @bind-Value="oInput.Password"
                           class="form-control"
                           placeholder="password" />
                <label>Password</label>
            </div>

            @if (!string.IsNullOrEmpty(sError))
            {
                <div class="alert alert-danger">@sError</div>
            }

            <button type="submit" class="btn btn-primary w-100">
                Log in
            </button>
        </EditForm>
    </div>
</div>

@code {

    private LoginInputModel oInput = new();
    private string? sError;

    private async Task LoginUser()
    {
        sError = null;

        var oRequest = new LoginRequestDTO
        {
            Email = oInput.Email,
            Password = oInput.Password
        };

        var oResponse = await Http.PostAsJsonAsync("api/auth/login", oRequest);

        if (!oResponse.IsSuccessStatusCode)
        {
            sError = "Credenciales inválidas.";
            return;
        }

        var oLoginResponse = await oResponse.Content.ReadFromJsonAsync<LoginResponseDTO>();

        if (oLoginResponse is null)
        {
            sError = "Error al procesar la respuesta.";
            return;
        }

        oSessionService.SetSession(oLoginResponse);

        Navigation.NavigateTo("/");
    }

    private sealed class LoginInputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required]
        public string Password { get; set; } = string.Empty;
    }
}
