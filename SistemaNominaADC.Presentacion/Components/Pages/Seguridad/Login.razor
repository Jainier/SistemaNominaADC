@using SistemaNominaADC.Presentacion_Old.Core.Security
@using System.ComponentModel.DataAnnotations

@page "/login"
@attribute [AllowAnonymous]

@inject AuthService AuthService
@inject NavigationManager NavigationManager 


<h3>Iniciar Sesión</h3>


<EditForm Model="@_loginModel" OnValidSubmit="@HandleLogin" FormName="LoginForm">
    <DataAnnotationsValidator />
    
    <label>Usuario:</label>
    <InputText @bind-Value="_loginModel.Username" />
    <ValidationMessage For="@(() => _loginModel.Username)" />

    <label>Contraseña:</label>
    <InputText @bind-Value="_loginModel.Password" type="password" />
    <ValidationMessage For="@(() => _loginModel.Password)" />

    <button type="submit" disabled="@_isLoading">
        @(_isLoading ? "Cargando..." : "Entrar")
    </button>
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div style="color: red;">@_errorMessage</div>
    }
</EditForm>

@code {
    private LoginModel _loginModel = new();
    private string _errorMessage = string.Empty;
    private bool _isLoading = false;

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        
        var sesion = await AuthService.LoginAsync(_loginModel.Username, _loginModel.Password);

        if (sesion != null)
        {
            NavigationManager.NavigateTo("/", true);
        }
        else
        {
            _errorMessage = "Usuario o contraseña inválidos. Inténtalo de nuevo.";
        }
        
        _isLoading = false;
    }
}